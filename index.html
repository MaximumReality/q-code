<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Q-Code Final Fix</title>
<style>
  :root { --neon-pink:#ff00ff; --neon-cyan:#00ffff; }
  body {
    margin:0; background:url('clean-poster.PNG') no-repeat center center fixed;
    background-size:cover; overflow:hidden; font-family:'Courier New', monospace;
  }
  #score-display {
    position:fixed; top:20px; left:20px; font-size:1.8rem; 
    color:var(--neon-cyan); text-shadow:0 0 10px var(--neon-cyan); z-index: 100;
  }
  #control-deck { position:fixed; top:20px; right:20px; display:flex; gap:15px; z-index:10000; }
  .deck-icon { font-size:2rem; cursor:pointer; text-decoration: none; filter: drop-shadow(0 0 5px var(--neon-cyan)); }
  #p5-container { position: absolute; top: 0; left: 0; }
</style>
</head>
<body>

<div id="score-display">Score: 0</div>

<div id="control-deck">
    <span id="mute-btn" class="deck-icon" onclick="toggleMute()">üîä</span>
    <span id="play-pause-btn" class="deck-icon" onclick="togglePlay()">‚èØÔ∏è</span>
    <a href="https://maximumreality.xyz" id="home-link" class="deck-icon">üè°</a>
</div>

<div id="p5-container"></div>

<audio id="bgMusic" src="a-sunny-day.mp3" loop preload="auto"></audio>
<audio id="hopSound" src="hop.wav" preload="auto"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
<script>
let levelsData = [6, 5, 4], currentLevel = 0, cubes = [], azul, azulTarget, popFrames = 0;
let azulCurses = ["@!#?@!", "??!!#", "#$%@!", "G-L-I-T-C-H"];
let score = 0, isMuted = false, isPaused = true;

const bgMusic = document.getElementById('bgMusic');
const hopSound = document.getElementById('hopSound');

// --- INTEGRATED YOUR CONTROL DECK LOGIC ---
function toggleMute() {
    isMuted = !isMuted; 
    bgMusic.muted = isMuted;
    hopSound.muted = isMuted;
    document.getElementById('mute-btn').innerText = isMuted ? "üîá" : "üîä";
}

function togglePlay() {
    isPaused = !isPaused;
    if (isPaused) { 
        bgMusic.pause(); 
    } else { 
        bgMusic.play().catch(e => console.log("User interaction needed"));
    }
}

function goHome() { window.location.href = "https://MaximumReality.xyz"; }

new p5((sketch) => {
  let cubeSize = 42; 
  let azulImg;

  sketch.preload = function() {
    azulImg = sketch.loadImage('azul-tactical.png');
  }

  sketch.setup = function() {
    sketch.createCanvas(sketch.windowWidth, sketch.windowHeight).parent('p5-container');
    setupPyramid();
  }

  sketch.draw = function() {
    sketch.clear();
    
    // 1. Draw solid 3D cubes (Back to Front)
    for (let r = 0; r < cubes.length; r++) {
      for (let c = 0; c < cubes[r].length; c++) {
        drawSolidCube(cubes[r][c], sketch);
      }
    }

    // 2. Azul Physics
    azul.x += (azulTarget.x - azul.x) * 0.2;
    azul.y += (azulTarget.y - azul.y) * 0.2;
    let jumpY = popFrames > 0 ? Math.sin(sketch.map(popFrames, 0, 12, 0, Math.PI)) * 20 : 0;

    sketch.imageMode(sketch.CENTER);
    sketch.image(azulImg, azul.x, azul.y - 30 - jumpY, 75, 75);

    if (popFrames > 0) popFrames--;

    // 3. Azul Cussing
    cubes.flat().forEach(cube => {
      if (cube.pop > 0) {
        sketch.fill('#00ffff');
        sketch.textAlign(sketch.CENTER);
        sketch.textSize(22);
        sketch.text(cube.msg, cube.x, cube.y - 80 - (10 - cube.pop));
        cube.pop--;
      }
    });
  }

  sketch.mousePressed = function() {
    // START AUDIO ON FIRST TOUCH (Safari requirement)
    if (isPaused) {
        isPaused = false;
        bgMusic.play();
    }

    for (let r = 0; r < cubes.length; r++) {
      for (let c = 0; c < cubes[r].length; c++) {
        let cube = cubes[r][c];
        if (sketch.dist(sketch.mouseX, sketch.mouseY, cube.x, cube.y) < 35) {
          if (!cube.compiled) { score++; cube.compiled = true; }
          azulTarget.x = cube.x;
          azulTarget.y = cube.y;
          popFrames = 12;
          cube.pop = 20;
          cube.msg = sketch.random(azulCurses);
          
          if(!isMuted) {
              hopSound.currentTime = 0;
              hopSound.play();
          }
          document.getElementById('score-display').textContent = 'Score: ' + score;
        }
      }
    }
  }

  function drawSolidCube(cube, s) {
    let x = cube.x, y = cube.y, h = cubeSize;
    let topC = cube.compiled ? s.color(0, 255, 255) : s.color(255, 0, 85);
    let leftC = cube.compiled ? s.color(0, 150, 150) : s.color(150, 0, 50);
    let rightC = cube.compiled ? s.color(0, 200, 200) : s.color(200, 0, 70);

    s.push(); s.translate(x, y); s.noStroke();
    s.quad(0, -h, h*1.2, -h/2, 0, 0, -h*1.2, -h/2); // TOP
    s.fill(leftC); s.quad(-h*1.2, -h/2, 0, 0, 0, h, -h*1.2, h/2); // LEFT
    s.fill(rightC); s.quad(0, 0, h*1.2, -h/2, h*1.2, h/2, 0, h); // RIGHT
    s.fill(topC); s.quad(0, -h, h*1.2, -h/2, 0, 0, -h*1.2, -h/2); // Re-fill top last
    s.pop();
  }

  function setupPyramid() {
    cubes = [];
    let lvl = levelsData[currentLevel];
    let topY = 220; // Peak position

    for (let r = 0; r < lvl; r++) {
      let row = [];
      for (let c = 0; c <= r; c++) {
        // Narrower for Pro Max screen
        let x = sketch.width / 2 + (c - r / 2) * (cubeSize * 2.1);
        let y = topY + r * (cubeSize * 0.9);
        row.push({ x, y, compiled: false, pop: 0, msg: "" });
      }
      cubes.push(row);
    }
    azul = { x: cubes[0][0].x, y: cubes[0][0].y };
    azulTarget = { ...azul };
  }
}, 'p5-container');
</script>
</body>
</html>
