<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Q-Code Restoration</title>
<style>
  :root { --neon-pink:#ff00ff; --neon-cyan:#00ffff; }
  body {
    margin:0; background:url('clean-poster.PNG') no-repeat center center fixed;
    background-size:cover; overflow:hidden; font-family:'Courier New', monospace;
  }
  #score-display {
    position:fixed; top:20px; left:20px; font-size:1.8rem; 
    color:var(--neon-cyan); text-shadow:0 0 10px var(--neon-cyan); z-index: 100;
  }
  #hud-controls { position:fixed; top:20px; right:20px; display:flex; gap:15px; z-index:10000; }
  .hud-btn { font-size:2rem; cursor:pointer; }
  #p5-container { position: absolute; top: 0; left: 0; }
  
  /* The Fix for the Audio Toggle Icon */
  #mute-btn::after { content: "üîä"; }
  .muted #mute-btn::after { content: "üîá"; }
</style>
</head>
<body id="game-body">

<div id="score-display">Score: 0</div>

<div id="hud-controls">
  <span class="hud-btn" onclick="goHome()">üè°</span>
  <span class="hud-btn" onclick="toggleMusic()">‚èØÔ∏è</span>
  <span class="hud-btn" id="mute-btn" onclick="toggleMute()"></span>
</div>

<div id="p5-container"></div>

<audio id="bgMusic" src="a-sunny-day.mp3" loop></audio>
<audio id="hopSound" src="hop.wav"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
<script>
let levelsData = [6, 5, 7], currentLevel = 0, cubes = [], azul, azulTarget, popFrames = 0;
let azulCurses = ["@!#?@!", "??!!#", "#$%@!", "G-L-I-T-C-H", "CORE_DUMP!!"];
let score = 0;

const bgMusic = document.getElementById('bgMusic');
const hopSound = document.getElementById('hopSound');

function toggleMusic() { bgMusic.paused ? bgMusic.play() : bgMusic.pause(); }
function toggleMute() { 
  bgMusic.muted = hopSound.muted = !bgMusic.muted;
  document.getElementById('game-body').classList.toggle('muted');
}
function goHome() { window.location.href = "https://MaximumReality.xyz"; }

new p5((sketch) => {
  let cubeW = 40; // NARROWER for iPhone screen
  let azulImg;

  sketch.preload = function() {
    azulImg = sketch.loadImage('azul-tactical.png');
  }

  sketch.setup = function() {
    sketch.createCanvas(sketch.windowWidth, sketch.windowHeight).parent('p5-container');
    setupPyramid();
  }

  sketch.draw = function() {
    sketch.clear();
    
    // 1. Draw solid 3D cubes (Back to Front)
    for (let r = 0; r < cubes.length; r++) {
      for (let c = 0; c < cubes[r].length; c++) {
        drawSolidCube(cubes[r][c], sketch);
      }
    }

    // 2. Azul Physics & Scaling
    azul.x += (azulTarget.x - azul.x) * 0.2;
    azul.y += (azulTarget.y - azul.y) * 0.2;
    let jumpY = popFrames > 0 ? Math.sin(sketch.map(popFrames, 0, 15, 0, Math.PI)) * 25 : 0;

    sketch.imageMode(sketch.CENTER);
    sketch.image(azulImg, azul.x, azul.y - 35 - jumpY, 80, 80); // Big Azul is back

    if (popFrames > 0) popFrames--;

    // 3. Q*bert Cussing
    cubes.flat().forEach(cube => {
      if (cube.showText > 0) {
        sketch.fill('#00ffff');
        sketch.textAlign(sketch.CENTER);
        sketch.textSize(24);
        sketch.text(cube.activeMsg, cube.x, cube.y - 80 - (20 - cube.showText));
        cube.showText--;
      }
    });
  }

  sketch.mousePressed = function() {
    // Attempt to start music on first touch (Safari requirement)
    if (bgMusic.paused) bgMusic.play();

    for (let r = 0; r < cubes.length; r++) {
      for (let c = 0; c < cubes[r].length; c++) {
        let cube = cubes[r][c];
        if (sketch.dist(sketch.mouseX, sketch.mouseY, cube.x, cube.y) < 35) {
          if (!cube.compiled) { score++; cube.compiled = true; }
          azulTarget.x = cube.x;
          azulTarget.y = cube.y;
          popFrames = 15;
          cube.activeMsg = sketch.random(azulCurses);
          cube.showText = 25;
          hopSound.currentTime = 0;
          hopSound.play();
          document.getElementById('score-display').textContent = 'Score: ' + score;
        }
      }
    }
  }

  function drawSolidCube(cube, s) {
    let x = cube.x, y = cube.y;
    let size = cubeW;
    
    let topC = cube.compiled ? s.color(0, 255, 255) : s.color(255, 0, 85);
    let leftC = cube.compiled ? s.color(0, 150, 150) : s.color(150, 0, 50);
    let rightC = cube.compiled ? s.color(0, 200, 200) : s.color(200, 0, 70);

    s.push();
    s.translate(x, y);
    // TOP
    s.fill(topC);
    s.quad(0, -size, size * 1.2, -size/2, 0, 0, -size * 1.2, -size/2);
    // LEFT
    s.fill(leftC);
    s.quad(-size * 1.2, -size/2, 0, 0, 0, size, -size * 1.2, size/2);
    // RIGHT
    s.fill(rightC);
    s.quad(0, 0, size * 1.2, -size/2, size * 1.2, size/2, 0, size);
    s.pop();
  }

  function setupPyramid() {
    cubes = [];
    let lvl = levelsData[currentLevel];
    // TIGHTER SPACING (cubeW * 2.1 instead of 2.4) to fit the screen
    for (let r = 0; r < lvl; r++) {
      let row = [];
      for (let c = 0; c <= r; c++) {
        let x = sketch.width / 2 + (c - r / 2) * (cubeW * 2.1);
        let y = 180 + r * (cubeW * 1.2);
        row.push({ x, y, compiled: false, showText: 0, activeMsg: "" });
      }
      cubes.push(row);
    }
    azul = { x: cubes[0][0].x, y: cubes[0][0].y };
    azulTarget = { x: cubes[0][0].x, y: cubes[0][0].y };
  }
}, 'p5-container');
</script>
</body>
</html>
