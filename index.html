<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Q-Code Restoration</title>
<style>
  :root { --neon-pink:#ff00ff; --neon-cyan:#00ffff; }
  body {
    margin:0; background:url('clean-poster.PNG') no-repeat center center fixed;
    background-size:cover; overflow:hidden; font-family:'Courier New', monospace;
  }
  #score-display {
    position:fixed; top:20px; left:20px; font-size:1.8rem; 
    color:var(--neon-cyan); text-shadow:0 0 10px var(--neon-cyan); z-index: 100;
  }
  #hud-controls { position:fixed; top:20px; right:20px; display:flex; gap:15px; z-index:10000; }
  .hud-btn { font-size:2rem; cursor:pointer; filter: drop-shadow(0 0 5px var(--neon-cyan)); }
  
  #p5-container { position: absolute; top: 0; left: 0; }

  /* Ensure the Mute button reflects the state */
  #mute-icon::after { content: "üîá"; }
  .is-unmuted #mute-icon::after { content: "üîä"; }
</style>
</head>
<body class="is-unmuted">

<div id="score-display">Score: 0</div>

<div id="hud-controls">
  <span class="hud-btn" onclick="goHome()">üè°</span>
  <span class="hud-btn" onclick="toggleMusic()">‚èØÔ∏è</span>
  <span class="hud-btn" id="mute-icon" onclick="toggleMute()"></span>
</div>

<div id="p5-container"></div>

<audio id="bgMusic" src="a-sunny-day.mp3" loop></audio>
<audio id="hopSound" src="hop.wav"></audio>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.js"></script>
<script>
let levelsData = [6, 7, 5], currentLevel = 0, cubes = [], azul, azulTarget, popFrames = 0;
let azulCurses = ["@!#?@!", "??!!#", "#$%@!", "G-L-I-T-C-H", "CORE_DUMP!!"];
let score = 0;

const bgMusic = document.getElementById('bgMusic');
const hopSound = document.getElementById('hopSound');
let isMuted = false;

function toggleMusic() { 
  if(bgMusic.paused) { bgMusic.play().catch(e => console.log("Unlock required")); }
  else { bgMusic.pause(); }
}

function toggleMute() { 
    isMuted = !isMuted; 
    bgMusic.muted = hopSound.muted = isMuted;
    document.body.classList.toggle('is-unmuted', !isMuted);
}

function goHome() { window.location.href = "https://MaximumReality.xyz"; }

new p5((sketch) => {
  let cubeSize = 45; // Size of the top diamond
  let azulImg;

  sketch.preload = function() {
    azulImg = sketch.loadImage('azul-tactical.png');
  }

  sketch.setup = function() {
    sketch.createCanvas(sketch.windowWidth, sketch.windowHeight).parent('p5-container');
    setupPyramid();
  }

  sketch.draw = function() {
    sketch.clear();
    
    // 1. Draw Cubes with 3D Depth
    for (let r = 0; r < cubes.length; r++) {
      for (let c = 0; c < cubes[r].length; c++) {
        drawSolidCube(cubes[r][c], sketch);
      }
    }

    // 2. Azul Movement (Bigger Sprite)
    azul.x += (azulTarget.x - azul.x) * 0.2;
    azul.y += (azulTarget.y - azul.y) * 0.2;
    let jumpY = popFrames > 0 ? Math.sin(sketch.map(popFrames, 0, 15, 0, Math.PI)) * 30 : 0;

    sketch.imageMode(sketch.CENTER);
    // Draw Azul larger so he fits the 3D blocks
    sketch.image(azulImg, azul.x, azul.y - 30 - jumpY, 80, 80);

    if (popFrames > 0) popFrames--;

    // 3. Q*bert Cussing Only
    cubes.flat().forEach(cube => {
      if (cube.showText > 0) {
        sketch.fill('#00ffff');
        sketch.textAlign(sketch.CENTER);
        sketch.textSize(24);
        sketch.text(cube.activeMsg, cube.x, cube.y - 100 - (20 - cube.showText));
        cube.showText--;
      }
    });
  }

  sketch.mousePressed = function() {
    // iPhone Gesture Unlock for Audio
    if (bgMusic.paused && !isMuted) bgMusic.play();

    for (let r = 0; r < cubes.length; r++) {
      for (let c = 0; c < cubes[r].length; c++) {
        let cube = cubes[r][c];
        if (sketch.dist(sketch.mouseX, sketch.mouseY, cube.x, cube.y) < 40) {
          if (!cube.compiled) { score++; cube.compiled = true; }
          
          azulTarget.x = cube.x;
          azulTarget.y = cube.y;
          popFrames = 15;
          
          cube.activeMsg = sketch.random(azulCurses);
          cube.showText = 25;

          if (!isMuted) { hopSound.currentTime = 0; hopSound.play(); }
          document.getElementById('score-display').textContent = 'Score: ' + score;
        }
      }
    }
  }

  function drawSolidCube(cube, s) {
    let x = cube.x;
    let y = cube.y;
    let h = cubeSize; // height of faces
    
    let tCol = cube.compiled ? s.color(0, 255, 255) : s.color(255, 0, 85);
    let lCol = cube.compiled ? s.color(0, 150, 150) : s.color(150, 0, 50);
    let rCol = cube.compiled ? s.color(0, 200, 200) : s.color(200, 0, 70);

    s.push();
    s.translate(x, y);
    
    // TOP FACE
    s.fill(tCol);
    s.quad(0, -h, h*1.2, -h/2, 0, 0, -h*1.2, -h/2);
    
    // LEFT FACE
    s.fill(lCol);
    s.quad(-h*1.2, -h/2, 0, 0, 0, h, -h*1.2, h/2);
    
    // RIGHT FACE
    s.fill(rCol);
    s.quad(0, 0, h*1.2, -h/2, h*1.2, h/2, 0, h);
    
    s.pop();
  }

  function setupPyramid() {
    cubes = [];
    let lvl = levelsData[currentLevel];
    for (let r = 0; r < lvl; r++) {
      let row = [];
      for (let c = 0; c <= r; c++) {
        let x = sketch.width / 2 + (c - r / 2) * (cubeSize * 2.4);
        let y = 200 + r * (cubeSize * 1.5);
        row.push({ x, y, compiled: false, showText: 0, activeMsg: "" });
      }
      cubes.push(row);
    }
    azul = { x: cubes[0][0].x, y: cubes[0][0].y };
    azulTarget = { x: cubes[0][0].x, y: cubes[0][0].y };
  }
}, 'p5-container');
</script>
</body>
</html>
